name: Test Integration

on:
  pull_request:
    branches: [master]
    paths-ignore:
      - "**.md"

env:
  COMPOSE_DOCKER_CLI_BUILD: 1
  DOCKER_BUILDKIT: 1

jobs:
  build_docker_images:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Maximize build space
        run: |
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          df -h
      - uses: actions/checkout@v3
        with:
          lfs: true
          submodules: recursive
      - name: Docker Login
        uses: docker/login-action@v1.12.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Build the Docker images
        run: |
          docker-compose pull
          docker-compose build --progress=plain
      - name: Cache the docker images
        run: |
          docker save utrarobosoccer/soccerbot > /tmp/soccerbot.tar
          docker save utrarobosoccer/webots > /tmp/webots.tar
      - name: Upload soccerbot image as artifact
        uses: actions/upload-artifact@v2
        with:
          name: soccerbot
          path: /tmp/soccerbot.tar
      - name: Upload webots image as artifact
        uses: actions/upload-artifact@v2
        with:
          name: webots
          path: /tmp/webots.tar
  run_integration_tests:
    runs-on: ubuntu-latest
    needs: build_docker_images
    strategy:
      fail-fast: false
      matrix:
        robot_model: [bez1, bez3]
    timeout-minutes: 60
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    env:
      ROBOT_MODEL: ${{ matrix.robot_model }}
    steps:
      - name: Maximize build space
        run: |
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          df -h
      - uses: actions/checkout@v3
        with:
          lfs: true
          submodules: recursive
      - name: Docker Login
        uses: docker/login-action@v1.12.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Download soccerbot artifact
        uses: actions/download-artifact@v2
        with:
          name: soccerbot
          path: /tmp/soccerbot.tar
      - name: Download webots artifact
        uses: actions/download-artifact@v2
        with:
          name: webots
          path: /tmp/webots.tar
      - name: Load Docker image
        run: |
          docker load --input /tmp/soccerbot.tar
          docker load --input /tmp/webots.tar
          docker image ls -a
      - name: Walking Integration Test
        run: |
          docker-compose -f docker-compose.test.yaml up --exit-code-from friendly
      - name: Get integration test logs
        if: always()
        run: |
          docker-compose logs
      - name: Get rosbag
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: Rosbags_Walking
          path: soccerbot/bags
      - name: Kick Integration Test
        run: |
          docker-compose -f docker-compose.test.kick.yaml up --exit-code-from friendly
      - name: Get integration test logs
        if: always()
        run: |
          docker-compose logs
      - name: Get rosbag
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: Rosbags_Kick
          path: soccerbot/bags
