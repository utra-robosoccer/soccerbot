<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Robot: soccer-embedded/docs/mainpage.md Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Robot
   </div>
   <div id="projectbrief">The embedded systems for UTRA&#39;s autonomous humanoid soccer-playing robot</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('dc/dc6/mainpage_8md.html','../../');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">soccer-embedded/docs/mainpage.md</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;@mainpage Welcome!</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;# Introduction</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;This is the documentation for the embedded software for UTRA&#39;s soccerbot.</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;This page contains some high-level descriptions of</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;how this software works. More details for each module can be found by browsing the Modules and Data Structures sections.</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;To return to UTRA&#39;s website, &lt;a href=&quot;http://utrahumanoid.ca/&quot;&gt;click here&lt;/a&gt;.</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;Our robot consists of 2 main computing solutions: a NVidia Jetson TX2 which runs the high-level software for controls and AI, and a STMicroelectronics 32-bit microcontroller. At a glance, the microcontroller software is responsible for:</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;-# Controlling the 18 actuators which form the robot&#39;s joints</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;-# Gathering sensor data</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;-# PC communication for receiving actuator commands and transmitting sensor data</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;It is important to note that all of these tasks must be accomplished with high efficiency and reliability.</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;# High-level Description</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;A STM32F446RE microcontroller on a custom PCB designed by the electrical team was chosen as the platform for the embedded systems. The software runs ontop of FreeRTOS, a real-time OS with a priority-based preemptive scheduler. All IO is DMA-based where possible, and interrupt-based otherwise. The peripherals involved are:</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;- MPU6050 inertial measurement unit</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;- Dynamixel MX-28 smart servo motor (x12)</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;- Dynamixel AX-12A smart servo motor (x6)</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;## Threads</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;The software consists of 10 threads (note: priority = 6 is the highest priority while priority = 0 is the lowest priority):</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;-# **RX, priority 6**: event-based, receives command packets from PC </div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;-# **TX, priority 5**: sends packets to the PC consisting of sensor data</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;-# **Command, priority 2**: event-based, parses the RobotGoal structure received by the RX thread and distributes read and write commands to the various UART threads</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;-# **UARTx (x=1,2,3,4,6), priority 3**: event-based, sends read and write commands sent from the Command thread to the motors</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;-# **MPU6050, priority 3**: time-triggered, reads acceleration and angular velocity and digitally filters angular velocity</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;-# **default, priority 0**: CubeMX-generated function that immediately sleeps</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;## Principle of Operation</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;The image below shows some of the possible interactions between the components of the system once the scheduler has started. Note how the program flow is largely sequentialâ€”not much happens until a command packet is received from the PC. This is an area we are working on improving in our next design iteration.</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;&lt;img src=&quot;..\Media\Design_RoboCup_2018\Design_RoboCup_2018.png&quot; width=&quot;80%&quot; alt=&quot;Steady-state flow&quot;&gt;</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;## Actuation</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;All actuation begins once a command packet has been received from the PC (handled by the RX thread). Only 1 type of packet is supported, with a rigid format consisting of goal angles for each joint. Once an entire packet has been received, the Command thread is woken up. The Command thread has 3 duties:</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;-# Convert the goal angles from the coordinate system used by the controls team to the coordinate system used by the motors</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;-# Send read and write commands to the UART corresponding to each motorâ€”this will update the goal position of each motor and read back the current position, enabling feedback control</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;-# Periodically assert &quot;torque enable&quot;. We decided that in the event of an actuator overheating and shutting itself off automatically (perhaps due to the robot being in a pose which requires that actuator to exert high amounts of torque), we would prefer to continue using the actuator (risking damage from heat) rather than compromising an important action our robot may be performing</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;Once a UART thread has received a command from the Command thread, it is woken up so that it can initiate the DMA-based information transfer to the actuator. Once the transfer has been initiated, the Command thread runs again and either (1) enqueues a command to the same UART, which it will process after its last transfer has completed, or (2) enqueues a command to a different UART, which will run immediately to begin an asynchronous transfer. This is repeated for all UARTs until all actuators goal positions have been updated, and until all positions have been read from the legs. It was decided to only use feedback from the legs on this iteration of the robot.</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;## Sensing</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;Orientation sensing is performed on a deterministic, time-triggered basis. This enables the design and use of digital filters since samples are fed in at a specific rate. For orientation, the MPU6050 is used to provide measurements of the acceleration (m/s^2) along the x-, y-, and z-axes of the sensor, and the angular velocity (deg/s) about these axes. Note that the coordinate system used by the sensor is different from the coordinate system used by the controls teamâ€”presently the controls team is performing these conversions in their software (Simulink and MATLAB). The controls software feeds these readings into a complementary filter to estimate orientation.</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;As for actuator position sensing, the process for sending commands to the motors was described above in the Actuation section. It turns out that the Command thread initiates _write_ commands for _all_ motors (setting the goal position for each actuator), and initiates _read_ commands for _only_ the motors in the legs. Thus, the current position for each motor is read directly after commanding it to go somewhereâ€”an example of coupling we are working on breaking in the future.</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;After all sensors (we can generalize the smart servos as a sensor for this discussion) have been read fromâ€”or we have attempted to read from themâ€”the TX thread will run, which sends a packet back to the PC with the sensor data.</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;# Plans for the Future</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;Our plans for the future are focussed on modularizing the system to reduce coupling between system components and generally improve flexibility. One major point of discussion has been a more flexible PC interface, and a _faster_ PC interface too since latency measurements proved 230,400 symbol/s UART was accounting for nearly 80% of the PC-MCU control cycle latency. &lt;a href=&quot;https://github.com/utra-robosoccer/soccer-embedded/issues/47&quot;&gt;Recent rests with Ethernet&lt;/a&gt; have proven the potential to reduce this number to about 5% (wow!). We are currently re-writing our code base in C++ and are using Google Test/Mock to ensure code quality _and_ make it easier for us to develop our software with limited hardware resources (we only have 1 robot, after all!). It is our belief that if we can test all the parts of our code which do not depend on hardware or the OS from the comfort of our PCs, it will speed up our development process.</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;Part of the reason for these changes is self-evident while another part is more internal to our organization. Each team has to work together to make sure each others&#39; needs are met, and these needs often evolve after development begins. Examples of this are that the controls team has indicated a desired to add pressure sensors, the electrical team is working on creating custom servo motors to reduce costs, and the reinforcement learning team has indicated a need to control the actuators via velocity control. Although these are all features we will be working on developing in the future, they also have cemented our convictions that a modular program structure will be essential to our future success.</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;## New Design</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;At a high-level, our future design looks something like what&#39;s shown below. For more details, please see &lt;a href=&quot;https://github.com/utra-robosoccer/soccer-embedded/issues/36&quot;&gt;Issue 36&lt;/a&gt; on our GitHub page.</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;&lt;img src=&quot;..\Media\Design_Future_2018\August-6-2018-Design_Full.png&quot; width=&quot;80%&quot; alt=&quot;Steady-state flow&quot;&gt;</div></div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><b>mainpage.md</b></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
